
<!-- templates/hr_all_requests.html (CORREGIDO) -->
{% extends "layout.html" %}
{% block content %}
<a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary shadow" style="position: fixed; top: 80px; right: 20px; z-index: 1050;">
    <i class="bi bi-arrow-left"></i> Volver al Panel
</a>

<div class="card" style="margin-top: 5rem;">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3>Todas las Solicitudes de Vacaciones</h3>
        <a href="{{ url_for('hr.hr_create_request') }}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Crear Solicitud para Empleado</a>
    </div>
    <div class="card-body">
        <form method="get" action="{{ url_for('hr.hr_all_requests') }}" class="row g-3 mb-4">
            <div class="col-md-3">
                <label for="employee_id" class="form-label">Empleado</label>
                <select name="employee_id" id="employee_id" class="form-select select2-multiple" multiple>
                    {% for emp in employees %}
                        <option value="{{ emp.id }}" {{ 'selected' if emp.id|string in filters.employee_id }}>{{ emp.full_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="status" class="form-label">Estado</label>
                <select name="status" id="status" class="form-select">
                    <option value="">-- Todos --</option>
                    <option value="Pendiente" {{ 'selected' if filters.status == 'Pendiente' }}>Pendiente</option>
                    <option value="Aprobado por Jefe" {{ 'selected' if filters.status == 'Aprobado por Jefe' }}>Aprobado por Jefe</option>
                    <option value="Aprobado por RRHH" {{ 'selected' if filters.status == 'Aprobado por RRHH' }}>Aprobado por RRHH</option>
                    <option value="Rechazado" {{ 'selected' if filters.status == 'Rechazado' }}>Rechazado</option>
                    <option value="Anulación Pendiente Jefe" {{ 'selected' if filters.status == 'Anulación Pendiente Jefe' }}>Anulación Pendiente Jefe</option>
                    <option value="Anulación Pendiente RRHH" {{ 'selected' if filters.status == 'Anulación Pendiente RRHH' }}>Anulación Pendiente RRHH</option>
                    <option value="Anulado" {{ 'selected' if filters.status == 'Anulado' }}>Anulado</option>
                    <option value="Activo" {{ 'selected' if filters.status == 'Activo' }}>Activo</option>
                    <option value="Finalizado" {{ 'selected' if filters.status == 'Finalizado' }}>Finalizado</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="type" class="form-label">Tipo</label>
                <select name="type" id="type" class="form-select">
                    <option value="">-- Todos --</option>
                    <option value="FullDay" {{ 'selected' if filters.type == 'FullDay' }}>Día Completo</option>
                    <option value="HalfDay" {{ 'selected' if filters.type == 'HalfDay' }}>Medio Día</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="date_from" class="form-label">Desde</label>
                <input type="text" class="form-control datepicker" id="date_from" name="date_from" value="{{ filters.date_from }}" placeholder="DD/MM/YYYY" autocomplete="off">
            </div>
            <div class="col-md-2">
                <label for="date_to" class="form-label">Hasta</label>
                <input type="text" class="form-control datepicker" id="date_to" name="date_to" value="{{ filters.date_to }}" placeholder="DD/MM/YYYY" autocomplete="off">
            </div>
            <div class="col-md-3 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary flex-grow-1"><i class="bi bi-search"></i> Filtrar</button>
                <button type="submit" name="export" value="true" class="btn btn-success flex-grow-1"><i class="bi bi-file-earmark-excel"></i> Exportar</button>
                <a href="{{ url_for('hr.hr_all_requests') }}" class="btn btn-outline-secondary" title="Limpiar Filtros"><i class="bi bi-x-lg"></i></a>
            </div>
        </form>
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Empleado</th>
                        <th>Jefe Directo</th>
                        <th>Fechas</th>
                        <th>Días</th>
                        <th>Estado</th>
                        <th>Adjunto</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr>
                        <td>{{ req.employee_name }}</td>
                        <td>{{ req.manager_name or 'N/A' }}</td>
                        <td>{{ req.start_date|format_date }} al {{ req.end_date|format_date }}</td>
                        <td>{{ req.days_requested }}
                            {% if req.request_type == 'HalfDay' and req.start_time %}
                                <small class="text-muted">({{ req.start_time }})</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if req.status == 'Aprobado por RRHH' %}
                                <span class="badge bg-success">Aprobado</span>
                            {% elif req.status == 'Activo' %}
                                <span class="badge bg-primary">Activo</span>
                            {% elif req.status == 'Rechazado' %}
                                <span class="badge bg-danger">Rechazado</span>
                            {% elif req.status == 'Pendiente' %}
                                <span class="badge bg-warning text-dark">Pendiente Aprob. Jefe</span>
                            {% elif req.status == 'Aprobado por Jefe' %}
                                <span class="badge bg-info text-dark">Pendiente Aprob. RRHH</span>
                            {% elif req.status == 'Finalizado' %}
                                <span class="badge bg-secondary">Finalizado</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ req.status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if req.attachment_path %}
                                <a href="{{ url_for('vacation_routes.download_attachment', filename=req.attachment_path) }}" class="btn btn-sm btn-outline-primary" target="_blank"><i class="bi bi-paperclip"></i> Ver</a>
                            {% endif %}
                        </td>
                        <td>
                            {% if session.base_role != 'Asistente RRHH' %}
                            {% if req.status == 'Aprobado por RRHH' or req.status == 'Activo' %}
                            <button type="button" class="btn btn-sm btn-warning" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#interruptModal"
                                    data-id="{{ req.id }}"
                                    data-employee="{{ req.employee_name }}"
                                    data-start="{{ req.start_date|format_date }}"
                                    data-end="{{ req.end_date|format_date }}"
                                    data-days="{{ req.days_requested }}">
                                <i class="bi bi-scissors"></i> Cortar
                            </button>
                            
                            <button type="button" class="btn btn-sm btn-info"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modifyDaysModal"
                                    data-id="{{ req.id }}"
                                    data-employee="{{ req.employee_name }}"
                                    data-days="{{ req.days_requested }}"
                                    data-start="{{ req.start_date|format_date }}"
                                    data-end="{{ req.end_date|format_date }}">
                                <i class="bi bi-pencil-square"></i> Modificar
                            </button>
                            {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center">No se encontraron solicitudes con los filtros seleccionados.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de Interrupción -->
<div class="modal fade" id="interruptModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cortar Periodo de Vacaciones</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="interruptForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>Empleado:</strong> <span id="modalEmployee"></span><br>
                        <strong>Inicio:</strong> <span id="modalStart"></span><br>
                        <strong>Fin Actual:</strong> <span id="modalEnd"></span><br>
                        <strong>Total Días:</strong> <span id="modalDays"></span>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label for="reintegration_date" class="form-label">Fecha de Reintegración (Día que vuelve)</label>
                        <input type="text" class="form-control datepicker" id="reintegration_date" name="reintegration_date" required autocomplete="off">
                        <div class="form-text">Se calcularán los días a devolver hasta el día anterior a esta fecha.</div>
                    </div>
                    <div class="mb-3">
                        <label for="interruption_reason" class="form-label">Comentario (Obligatorio)</label>
                        <textarea class="form-control" id="interruption_reason" name="interruption_reason" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Confirmar Corte</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Modificación Manual de Días -->
<div class="modal fade" id="modifyDaysModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modificar Días Asignados</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="modifyDaysForm" method="POST">
                <div class="modal-body">
                    <p><strong>Empleado:</strong> <span id="modEmployee"></span></p>
                    <div class="mb-3">
                        <label class="form-label">Modificar Fechas (Días actuales: <span id="modCurrentDays"></span>)</label>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="new_start_date" class="form-label text-muted small">Nueva Fecha Inicio</label>
                                <input type="text" class="form-control datepicker" id="new_start_date" name="new_start_date" required autocomplete="off">
                            </div>
                            <div class="col-md-6">
                                <label for="new_end_date" class="form-label text-muted small">Nueva Fecha Fin</label>
                                <input type="text" class="form-control datepicker" id="new_end_date" name="new_end_date" required autocomplete="off">
                            </div>
                        </div>
                        <div class="form-text mt-2">El sistema recalculará automáticamente los días hábiles y ajustará el saldo.</div>
                    </div>
                    <div class="mb-3">
                        <label for="modification_reason" class="form-label">Motivo de la Modificación (Obligatorio)</label>
                        <textarea class="form-control" id="modification_reason" name="modification_reason" rows="3" required placeholder="Ej: Error en cálculo, ajuste manual, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function(){
        $('.datepicker').datepicker({
            format: 'dd/mm/yyyy',
            autoclose: true,
            todayHighlight: true,
            language: 'es'
        });

        var interruptModal = document.getElementById('interruptModal');
        interruptModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var id = button.getAttribute('data-id');
            
            document.getElementById('modalEmployee').textContent = button.getAttribute('data-employee');
            document.getElementById('modalStart').textContent = button.getAttribute('data-start');
            document.getElementById('modalEnd').textContent = button.getAttribute('data-end');
            document.getElementById('modalDays').textContent = button.getAttribute('data-days');
            
            document.getElementById('interruptForm').action = '/hr/interrupt_vacation/' + id;
        });

        var modifyDaysModal = document.getElementById('modifyDaysModal');
        modifyDaysModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var id = button.getAttribute('data-id');
            
            document.getElementById('modEmployee').textContent = button.getAttribute('data-employee');
            document.getElementById('modCurrentDays').textContent = button.getAttribute('data-days');
            
            $('#new_start_date').datepicker('update', button.getAttribute('data-start'));
            $('#new_end_date').datepicker('update', button.getAttribute('data-end'));
            
            document.getElementById('modifyDaysForm').action = '/hr/modify_days/' + id;
        });
    });
</script>
{% endblock %}